<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Abnel Pradhan â€” Dynamic Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* --- Smooth Scrolling --- */
        html {
            scroll-behavior: smooth;
        }

        /* --- Base Styling --- */
        body {
            font-family: 'Inter', sans-serif;
            /* We use bg-gray-950 in the body tag for the base */
        }

        /* Gradient text for the hero title (Unchanged) */
        .hero h1 {
            background-image: linear-gradient(to right, #a5b4fc, #c084fc, #f0abfc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        /* Animated profile picture border (Unchanged) */
        @keyframes rotate-gradient {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animated-gradient-border {
            position: relative;
        }
        .animated-gradient-border::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: conic-gradient(#a5b4fc, #c084fc, #f0abfc, #a5b4fc);
            animation: rotate-gradient 4s linear infinite;
            z-index: 1;
        }

        /* --- Entrance Animations --- */
        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Animation classes */
        .animate-slide-in-down {
            animation: slideInDown 0.6s ease-out 0.2s backwards;
        }
        .animate-slide-in-up {
            animation: slideInUp 0.6s ease-out 0.4s backwards;
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out 0.2s backwards;
        }


        /* --- Animated Aurora Background Blobs (Unchanged) --- */
        @keyframes moveBlob1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40vw, -30vh) scale(1.2); }
            50% { transform: translate(20vw, 20vh) scale(0.8); }
            75% { transform: translate(-30vw, -20vh) scale(1.1); }
        }
        @keyframes moveBlob2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-30vw, 20vh) scale(1.1); }
            50% { transform: translate(10vw, -40vh) scale(0.9); }
            75% { transform: translate(30vw, 10vh) scale(1.2); }
        }
        @keyframes moveBlob3 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(20vw, 30vh) scale(0.8); }
            50% { transform: translate(-30vw, -10vh) scale(1.2); }
            75% { transform: translate(-10vw, 20vh) scale(1); }
        }

        .aurora-blob {
            position: absolute;
            border-radius: 9999px; /* rounded-full */
            filter: blur(100px); /* Heavy blur for soft edges */
            opacity: 0.4; /* Softer opacity */
            mix-blend-mode: hard-light; /* Blends colors nicely */
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 font-sans">

    <!-- Background Blobs -->
    <div class="aurora-background fixed top-0 left-0 w-full h-full z-[-10] overflow-hidden">
        <div class="aurora-blob w-[500px] h-[500px] bg-indigo-500 top-[10vh] left-[10vw]" style="animation: moveBlob1 20s infinite alternate;"></div>
        <div class="aurora-blob w-[400px] h-[400px] bg-purple-500 top-[40vh] left-[60vw]" style="animation: moveBlob2 25s infinite alternate;"></div>
        <div class="aurora-blob w-[450px] h-[450px] bg-pink-500 top-[60vh] left-[30vw]" style="animation: moveBlob3 18s infinite alternate;"></div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-gray-950/70 backdrop-blur-lg shadow-xl border-b border-indigo-500/30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                
                <div class="flex items-center gap-4">
                    <div class="relative w-12 h-12 animated-gradient-border rounded-full p-0.5 overflow-hidden hidden md:block">
                        <!-- Placeholder for profile.jpg -->
                        <img 
                            src="profile.jpg" 
                            alt="Abnel Pradhan" 
                            class="w-full h-full rounded-full object-cover relative z-10"
                            onerror="this.src='https://placehold.co/100x100/1e1b4b/a5b4fc?text=AP'"
                        >
                    </div>
                    <a class="text-2xl font-bold text-white hover:text-indigo-400 transition duration-300" href="#">
                        Abnel Pradhan
                    </a>
                </div>

                <nav class="hidden md:flex space-x-8" id="main-nav-desktop">
                    <a href="#home" class="text-gray-300 hover:text-indigo-400 transition duration-300 font-medium">Home</a>
                    <a href="#projects" class="text-gray-300 hover:text-indigo-400 transition duration-300 font-medium">Projects</a>
                    <a href="#skills" class="text-gray-300 hover:text-indigo-400 transition duration-300 font-medium">Skills</a>
                    <a href="#chatbot" class="text-gray-300 hover:text-indigo-400 transition duration-300 font-medium">AI Assistant ðŸ’¬</a>
                    <a href="#contact" class="text-gray-300 hover:text-indigo-400 transition duration-300 font-medium">Contact</a>
                </nav>

                <button class="md:hidden text-white focus:outline-none" id="mobile-menu-button" aria-label="Toggle menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div class="md:hidden hidden bg-gray-900/90 backdrop-blur-md" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#home" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-700 transition duration-300">Home</a>
                <a href="#projects" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-700 transition duration-300">Projects</a>
                <a href="#skills" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-700 transition duration-300">Skills</a>
                <a href="#chatbot" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-700 transition duration-300">AI Assistant ðŸ’¬</a>
                <a href="#contact" class="block px-3 py-2 rounded-md text-base font-medium text-white hover:bg-gray-700 transition duration-300">Contact</a>
            </div>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section id="home" class="hero min-h-screen flex items-center justify-center text-center p-4 border-b border-gray-700/50">
            <div class="hero-inner max-w-4xl space-y-6">
                <h1 class="text-6xl sm:text-7xl lg:text-8xl animate-slide-in-down">Hi, I'm Abnel.</h1>
                <p class="subtitle text-xl sm:text-2xl text-gray-300 font-light animate-slide-in-up">
                    Welcome to my portfolio. BCA student skilled in coding, video editing, and creative AI tools.
                </p>
                <div class="pt-6 flex justify-center space-x-4 animate-fade-in-up" style="animation-delay: 0.6s;">
                    <a class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transform hover:scale-105 transition duration-300" href="#projects">
                        View Projects
                    </a>
                    <a class="px-6 py-3 border border-gray-400 text-gray-200 font-semibold rounded-full shadow-lg hover:bg-gray-700 transform hover:scale-105 transition duration-300" href="#contact">
                        Let's Talk
                    </a>
                </div>
            </div>
        </section>

        <!-- Projects Section -->
        <section id="projects" class="py-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-4xl font-extrabold text-white text-center mb-12 animate-fade-in-up">Recent Projects</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">

                    <article class="project-card bg-white/5 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden hover:shadow-indigo-500/50 transition duration-500 transform hover:-translate-y-1 border border-white/10 animate-fade-in-up" 
                             data-project-title="E-Commerce Platform" data-project-desc="A full-stack application demonstrating product management, user authentication, and a smooth checkout flow."
                             style="animation-delay: 0.2s;">
                        <div class="p-6 space-y-4">
                            <h3 class="text-2xl font-bold text-indigo-400">E-Commerce Platform</h3>
                            <p class="text-gray-300">A full-stack application demonstrating product management, user authentication, and a smooth checkout flow.</p>
                            <div class="flex flex-wrap gap-2">
                                <span class="bg-indigo-900/70 text-indigo-300 text-xs font-semibold px-2.5 py-0.5 rounded-full">React</span>
                                <span class="bg-indigo-900/70 text-indigo-300 text-xs font-semibold px-2.5 py-0.5 rounded-full">Node.js</span>
                                <span class="bg-indigo-900/70 text-indigo-300 text-xs font-semibold px-2.5 py-0.5 rounded-full">MongoDB</span>
                            </div>
                            <a href="#" class="inline-flex items-center text-indigo-400 hover:text-indigo-300 font-medium transition duration-300">
                                View Live Demo &rarr;
                            </a>
                        </div>
                    </article>

                    <article class="project-card bg-white/5 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden hover:shadow-purple-500/50 transition duration-500 transform hover:-translate-y-1 border border-white/10 animate-fade-in-up" 
                             data-project-title="Real-time Chat App" data-project-desc="Built a low-latency chat application using WebSockets for instant messaging between users."
                             style="animation-delay: 0.4s;">
                        <div class="p-6 space-y-4">
                            <h3 class="text-2xl font-bold text-purple-400">Real-time Chat App</h3>
                            <p class="text-gray-300">Built a low-latency chat application using WebSockets for instant messaging between users.</p>
                            <div class="flex flex-wrap gap-2">
                                <span class="bg-purple-900/70 text-purple-300 text-xs font-semibold px-2.5 py-0.5 rounded-full">Vue.js</span>
                                <span class="bg-purple-900/70 text-purple-300 text-xs font-semibold px-2.5 py-0.5 rounded-full">Socket.IO</span>
                                <span class="bg-purple-900/70 text-purple-300 text-xs font-semibold px-2.5 py-0.5 rounded-full">Express</span>
                            </div>
                            <a href="#" class="inline-flex items-center text-purple-400 hover:text-purple-300 font-medium transition duration-300">
                                View Code &rarr;
                            </a>
                        </div>
                    </article>

                    <article class="project-card bg-white/5 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden hover:shadow-pink-500/50 transition duration-500 transform hover:-translate-y-1 border border-white/10 animate-fade-in-up" 
                             data-project-title="Data Visualization Dashboard" data-project-desc="A clean dashboard that visualizes complex datasets using D3.js for interactive charts."
                             style="animation-delay: 0.6s;">
                        <div class="p-6 space-y-4">
                            <h3 class="text-2xl font-bold text-pink-400">Data Visualization Dashboard</h3>
                            <p class="text-gray-300">A clean dashboard that visualizes complex datasets using D3.js for interactive charts.</p>
                            <div class="flex flex-wrap gap-2">
                                <span class="bg-pink-900/70 text-pink-300 text-xs font-semibold px-2.5 py-0.5 rounded-full">HTML/CSS/JS</span>
                                <span class="bg-pink-900/70 text-pink-300 text-xs font-semibold px-2.5 py-0.5 rounded-full">D3.js</span>
                                <span class="bg-pink-900/70 text-pink-300 text-xs font-semibold px-2.5 py-0.5 rounded-full">Tailwind</span>
                            </div>
                            <a href="#" class="inline-flex items-center text-pink-400 hover:text-pink-300 font-medium transition duration-300">
                                View Case Study &rarr;
                            </a>
                        </div>
                    </article>

                </div>
            </div>
        </section>

        <!-- Skills Section -->
        <section id="skills" class="py-20 border-t border-gray-700/50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-4xl font-extrabold text-white text-center mb-12 animate-fade-in-up">My Core Skills</h2>
                <div class="flex flex-wrap justify-center gap-4" id="skill-list">
                    <div class="bg-white/10 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-white/10 transition duration-300 hover:border-indigo-400 animate-fade-in-up" data-skill="JavaScript (ES6+)" style="animation-delay: 0.1s;">
                        <p class="text-lg font-medium text-white">JavaScript (ES6+)</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-white/10 transition duration-300 hover:border-indigo-400 animate-fade-in-up" data-skill="React & Next.js" style="animation-delay: 0.2s;">
                        <p class="text-lg font-medium text-white">React & Next.js</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-white/10 transition duration-300 hover:border-indigo-400 animate-fade-in-up" data-skill="Tailwind CSS" style="animation-delay: 0.3s;">
                        <p class="text-lg font-medium text-white">Tailwind CSS</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-white/10 transition duration-300 hover:border-indigo-400 animate-fade-in-up" data-skill="Node.js & Express" style="animation-delay: 0.4s;">
                        <p class="text-lg font-medium text-white">Node.js & Express</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-white/10 transition duration-300 hover:border-indigo-400 animate-fade-in-up" data-skill="SQL/NoSQL Databases" style="animation-delay: 0.5s;">
                        <p class="text-lg font-medium text-white">SQL/NoSQL Databases</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-white/10 transition duration-300 hover:border-indigo-400 animate-fade-in-up" data-skill="Git & DevOps" style="animation-delay: 0.6s;">
                        <p class="text-lg font-medium text-white">Git & DevOps</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-white/10 transition duration-300 hover:border-indigo-400 animate-fade-in-up" data-skill="Web development" style="animation-delay: 0.7s;">
                        <p class="text-lg font-medium text-white">Web Development</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chatbot Section -->
        <section id="chatbot" class="py-20 border-t border-gray-700/50">
            <div class="max-w-xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-4xl font-extrabold text-white text-center mb-10 animate-fade-in-up">AI Assistant ðŸ’¬</h2>
                <p class="text-center text-gray-300 mb-8 animate-fade-in-up" style="animation-delay: 0.2s;">
                    Chat with an AI about Abnel's skills and projects to learn more about my background.
                </p>

                <div class="bg-white/5 backdrop-blur-md rounded-2xl shadow-2xl border border-white/10 flex flex-col h-[500px] animate-fade-in-up" style="animation-delay: 0.4s;">
                    
                    <div id="chat-window" class="flex-grow overflow-y-auto p-4 space-y-4">
                        <!-- Chat messages will be dynamically inserted here -->
                    </div>

                    <div class="p-4 border-t border-white/10 flex">
                        <input id="chat-input" type="text" placeholder="Ask about my skills or projects..." class="flex-grow px-4 py-2 bg-white/10 border border-white/20 rounded-l-lg text-white focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400" />
                        <button id="send-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-r-lg hover:bg-indigo-700 transition duration-300 disabled:opacity-50" type="button">
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="py-20 border-t border-gray-700/50">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-4xl font-extrabold text-white text-center mb-10 animate-fade-in-up">Get in Touch</h2>
                <p class="text-center text-gray-300 mb-8 animate-fade-in-up" style="animation-delay: 0.2s;">Ready to start a project? Send me a message, and I'll get back to you as soon as possible.</p>

                <!-- 
                  ============================================================
                  === THIS IS THE CRITICAL FIX FOR THE NETLIFY FORM ===
                  ============================================================
                  We added:
                  1. name="contact" (Tells Netlify the name of this form)
                  2. method="POST" (Standard for form submission)
                  3. data-netlify="true" (Tells Netlify's build system to "register" this form)
                -->
                <form id="contactForm" name="contact" method="POST" data-netlify="true" novalidate class="space-y-6 bg-white/5 backdrop-blur-md p-8 rounded-2xl shadow-2xl border border-white/10 animate-fade-in-up" style="animation-delay: 0.4s;">
                    
                    <!-- 
                      This hidden field is CRITICAL for JavaScript-based submissions.
                      It tells Netlify's backend which form the data belongs to.
                    -->
                    <input type="hidden" name="form-name" value="contact" />

                    <div class="form-row">
                        <label for="name" class="block text-sm font-medium text-gray-200 mb-1">Name</label>
                        <input id="name" name="name" type="text" required class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500" />
                    </div>
                    <div class="form-row">
                        <label for="email" class="block text-sm font-medium text-gray-200 mb-1">Email</label>
                        <input id="email" name="email" type="email" required class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500" />
                    </div>
                    <div class="form-row">
                        <label for="message" class="block text-sm font-medium text-gray-200 mb-1">Message</label>
                        <textarea id="message" name="message" rows="5" required class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between pt-2">
                        <button class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition duration-300" type="submit">
                            Send Message
                        </button>
                        <span id="formFeedback" role="status" aria-live="polite" class="mt-4 sm:mt-0 text-green-400 font-medium"></span>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-transparent border-t border-indigo-700/50 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-400">
            <!-- Corrected copyright year -->
            <p>Â© <span id="year"></span> Abnel Pradhan â€” All rights reserved</p>
        </div>
    </footer>

    <script>
        // --- API Configuration Removed ---
        // We no longer define API_URL or API_KEY here.
        // The frontend will call our own secure Netlify Function.

        // Global state variables
        let chatHistory = [];
        let botIsTyping = false;
        let userSkills = [];
        let userProjects = [];
        let SYSTEM_INSTRUCTION_BASE = ""; // Will be set during DOMContentLoaded

        /**
         * Simple exponential backoff retry mechanism.
         * @param {function} fn - The async function to retry.
         * @param {number} retries - Number of retries.
         * @param {number} delay - Initial delay in ms.
         */
        async function fetchWithBackoff(fn, retries = 3, delay = 1000) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    lastError = error;
                    if (error.status === 429 || error.status >= 500) {
                        // Only retry on rate limiting or server errors
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        // Don't retry on other errors (e.g., 400 Bad Request)
                        throw error;
                    }
                }
            }
            throw lastError;
        }

        /**
         * Creates and displays a message bubble in the chat window.
         * @param {string} sender - 'user' or 'model'.
         * @param {string} text - The message content.
         */
        function displayMessage(sender, text) {
            const chatWindow = document.getElementById('chat-window');
            const messageContainer = document.createElement('div');
            
            const isTypingIndicator = text === 'typing';

            if (sender === 'user') {
                // User message styling
                messageContainer.className = 'flex justify-end';
                messageContainer.innerHTML = `
                    <div class="bg-indigo-600 text-white max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl rounded-br-none shadow-md">
                        ${text}
                    </div>
                `;
            } else {
                // Bot message styling
                messageContainer.className = 'flex justify-start';
                if (isTypingIndicator) {
                    messageContainer.id = 'typing-indicator';
                    messageContainer.innerHTML = `
                        <div class="bg-gray-700/70 text-gray-300 p-3 rounded-xl rounded-tl-none shadow-md">
                            <div class="flex items-center space-x-1">
                                <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-75"></div>
                                <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-150"></div>
                                <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-300"></div>
                            </div>
                        </div>
                    `;
                } else {
                    messageContainer.innerHTML = `
                        <div class="bg-gray-700/70 text-gray-200 max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl rounded-tl-none shadow-md">
                            ${text.replace(/\n/g, '<br>')}
                        </div>
                    `;
                }
            }

            chatWindow.appendChild(messageContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        /**
         * Removes the 'typing' indicator from the chat window.
         */
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        /**
         * Handles the sending of a user message and getting the AI response.
         */
        async function handleSendMessage() {
            if (botIsTyping) return;

            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const userText = chatInput.value.trim();

            if (userText === '') return;

            chatInput.value = '';
            sendBtn.disabled = true;
            chatInput.disabled = true;
            botIsTyping = true;

            displayMessage('user', userText);
            chatHistory.push({ role: 'user', parts: [{ text: userText }] });

            displayMessage('model', 'typing');

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: SYSTEM_INSTRUCTION_BASE }]
                },
            };

            try {
                // --- UPDATED API CALL ---
                // Instead of calling Google directly, we call our own secure Netlify Function.
                const apiCall = async () => {
                    const response = await fetch("/.netlify/functions/chat", { // <-- This is the new URL
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload) // Send the same payload
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        const error = new Error(`HTTP error! status: ${response.status} ${errorBody}`);
                        error.status = response.status;
                        throw error;
                    }
                    return response.json(); // Our function will return the Gemini response
                };

                const result = await fetchWithBackoff(apiCall);
                
                // The 'result' is the JSON from our *own* backend function
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                removeTypingIndicator(); 

                if (generatedText) {
                    displayMessage('model', generatedText);
                    chatHistory.push({ role: 'model', parts: [{ text: generatedText }] });
                } else {
                    // Check for an error message from our function
                    const errorText = result.error || 'I apologize, I ran into an issue and cannot answer that right now.';
                    displayMessage('model', errorText);
                }

            } catch (error) {
                console.error("Chat Error:", error); // Changed from "Gemini API Error"
                removeTypingIndicator();
                displayMessage('model', 'An error occurred while connecting to the AI service. Please try again.');
            } finally {
                sendBtn.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
                botIsTyping = false;
            }
        }

        // --- Main DOM Content Loaded Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Standard initialization
            document.getElementById('year').textContent = new Date().getFullYear();
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const contactForm = document.getElementById('contactForm');
            const navLinks = document.querySelectorAll('#main-nav-desktop a, #mobile-menu a');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');

            // 2. Extract Skills and Projects for Chat Context
            const skillElements = document.querySelectorAll('#skill-list [data-skill]');
            userSkills = Array.from(skillElements).map(el => el.getAttribute('data-skill'));

            const projectElements = document.querySelectorAll('.project-card');
            userProjects = Array.from(projectElements).map(el => ({
                title: el.getAttribute('data-project-title'),
                desc: el.getAttribute('data-project-desc')
            }));
            
            // 3. System Instruction
            const skillList = userSkills.join(', ');
            const projectList = userProjects.map(p => `${p.title}: ${p.desc}`).join(' | ');
            
            SYSTEM_INSTRUCTION_BASE = `You are a friendly and professional AI Assistant for Abnel Pradhan's portfolio. Your goal is to answer questions about Abnel's skills and projects.
            
            ---
            **Abnel's Skills:** ${skillList}
            **Abnel's Projects:** ${projectList}
            ---
            
            Respond concisely and only use information related to Abnel's provided skills and projects. If a question is off-topic, politely redirect the user back to the portfolio content.`;


            // 4. Set up Chat Bot greeting
            const greeting = `Hello! I'm Abnel's AI Assistant. I can tell you more about Abnel's skills (like **${userSkills[0]}** or **${userSkills[2]}**) and projects (like the **${userProjects[0].title}**). What would you like to know?`;
            displayMessage('model', greeting);
            chatHistory.push({ role: 'model', parts: [{ text: greeting }] });
            
            // 5. Chat Bot Event Listeners
            if (sendBtn) {
                sendBtn.addEventListener('click', handleSendMessage);
            }
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSendMessage();
                    }
                });
            }

            // 6. Mobile Menu Listeners
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (!mobileMenu.classList.contains('hidden')) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            });

            // 7. Contact Form Listener (with Netlify AJAX submission)
            if (contactForm) {
                contactForm.addEventListener('submit', function(event) {
                    event.preventDefault(); // Stop default HTML submission

                    const form = event.target;
                    const feedback = document.getElementById('formFeedback');

                    // Validation
                    if (!form.checkValidity()) {
                        feedback.textContent = 'Please fill out all required fields correctly.';
                        feedback.classList.add('text-red-400');
                        feedback.classList.remove('text-green-400');
                        return;
                    }

                    // --- Correct: AJAX Submission for Netlify ---
                    const formData = new FormData(form);
                    
                    fetch("/", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams(formData).toString()
                    })
                    .then(() => {
                        // Success
                        feedback.textContent = 'Thank you, your message has been sent!';
                        feedback.classList.add('text-green-400');
                        feedback.classList.remove('text-red-400');

                        setTimeout(() => {
                            form.reset();
                            feedback.textContent = '';
                        }, 3000);
                    })
                    .catch((error) => {
                        // Error
                        feedback.textContent = 'Error sending message. Please try again.';
                        feedback.classList.add('text-red-400');
                        feedback.classList.remove('text-green-400');
                        console.error('Form submission error:', error);
                    });
                    // --- End of new logic ---
                });
            }
        });
    </script>
</body>
</html>